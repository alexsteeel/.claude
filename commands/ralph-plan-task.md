---
name: ralph-plan-task
description: Plan task (project#N) - analyze, create plan, get approval
arguments:
  - name: task_ref
    description: Task reference in format "project#N" (e.g., "myproject#18")
    required: true
---

Ты выполняешь ПЛАНИРОВАНИЕ задачи. Один запуск = одна задача.

## Принципы

- **Только планирование** — никакой реализации
- **С участием человека** — уточняй все неясности
- **Один запуск = одна задача** — после завершения планирования выходи

## КРИТИЧНО

**План записывается В ЗАДАЧУ через md-task-mcp в поле `plan`, а НЕ в локальный файл!**

```python
# ПРАВИЛЬНО — используй поле plan:
update_task(project="...", number=N, plan="текст плана", status="work")

# НЕПРАВИЛЬНО — НЕ добавляй план в body:
# body=existing_body + plan_text  # ❌ НЕ ДЕЛАЙ ТАК
```

EnterPlanMode создаёт временный файл `.plan.md` для твоих заметок во время анализа.
Финальный план ОБЯЗАТЕЛЬНО должен быть записан в поле `plan` задачи через `update_task()`.

**После записи плана в задачу — УДАЛИ временный файл `.plan.md`!**

## Входные данные

Task reference: `$ARGUMENTS`

## Workflow

### Phase 0: Get Task

Получи задачу через md-task-mcp:

```
get_task(project="<project>", number=<N>)
```

Проверь:
- Задача существует
- Есть описание (body)

Если задачи нет → выйди с ошибкой.

### Phase 1: Plan Mode

**Используй ultrathink mode** для глубокого анализа.

#### Шаг 1: Войди в Plan Mode

```
EnterPlanMode
```

#### Шаг 2: Анализ

1. **Прочитай проектную документацию**:
   - CLAUDE.md — правила разработки
   - README.md — структура проекта
   - docs/*.md — архитектура

2. **Проанализируй существующий код**:
   - Используй Glob, Grep, Read для поиска паттернов
   - Найди связанные компоненты и зависимости
   - Определи точки интеграции

3. **Создай план реализации** (полный и понятный, без деталей реализации):
   - **Scope**: файлы для модификации и новые файлы
   - **Code Context**: ключевые паттерны и зависимости
   - **Implementation Steps**: что нужно сделать
   - **Testing Strategy**: где тесты и что покрыть
   - **Documentation Updates**: что обновить

4. **Уточни ВСЕ неясные моменты**:
   - Используй AskUserQuestion для прояснения **всех** спорных, непонятных или неоднозначных моментов
   - Если есть несколько вариантов реализации — спроси какой предпочтительнее
   - Уточни детали если требования неполные или противоречивые
   - Обсуди сомнения в архитектуре с пользователем
   - **НЕ ЗАВЕРШАЙ планирование пока есть неясности**

5. **Оцени размер задачи**:
   - Если задача требует изменений в **более чем 5-7 файлах** или **затрагивает несколько модулей/подсистем** — предложи разбиение на подзадачи
   - Каждая подзадача должна быть **автономной** и **тестируемой отдельно**
   - Используй AskUserQuestion чтобы согласовать разбиение с пользователем
   - При согласии — создай подзадачи через `create_task()` и свяжи их через `depends_on`

#### Шаг 3: Выйди из Plan Mode

```
ExitPlanMode
```

**Жди одобрения плана от пользователя.**

### Phase 2: Save Plan to Task (ОБЯЗАТЕЛЬНО!)

**После одобрения плана ОБЯЗАТЕЛЬНО запиши его в поле `plan` задачи:**

⚠️ НЕ в локальный файл `.plan.md`, НЕ в `body` — только в поле `plan`!

```python
# Подготовь план (полный и понятный, без деталей реализации)
plan_text = """
### Scope
Файлы для модификации:
- `path/to/file1.py` — что меняем
- `path/to/file2.py` — что меняем

Новые файлы (если нужны):
- `path/to/new_file.py` — назначение

### Code Context
Ключевые паттерны проекта:
- [Какие паттерны использовать]
- [Зависимости между модулями]

### Implementation Steps
1. [Что сделать]
2. [Что сделать]
...

### Testing Strategy
- Где тесты: `path/to/tests/`
- Что покрыть тестами

### Documentation Updates
[Что обновить]
"""

# Обнови задачу — используй поле plan!
update_task(
    project="<project>",
    number=<N>,
    status="work",
    started="<YYYY-MM-DD>",
    plan=plan_text  # ← ВАЖНО: поле plan, НЕ body!
)
```

Удали временный файл:
```bash
rm .plan.md
```

### Phase 3: Report

Выведи:

```
✅ ПЛАНИРОВАНИЕ ЗАВЕРШЕНО

Задача: {project}#{number} - {title}
Статус: work

План записан в задачу и готов к реализации.

Для автономной реализации используй:
/ralph-implement-python-task {project}#{number}
```

## Checklist

- [ ] Задача получена
- [ ] Документация изучена
- [ ] Код проанализирован
- [ ] План создан
- [ ] Все неясности уточнены
- [ ] Размер задачи оценён (если большая — предложено разбиение)
- [ ] План одобрен пользователем
- [ ] План записан в поле `plan` задачи (update_task с plan=)
- [ ] Статус = work
- [ ] Временный файл .plan.md удалён
